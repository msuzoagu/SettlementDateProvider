name: FeatureNotes

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - '**-milestone'
    head:
      - '**-milestone-**'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  pull-requests: write
  contents: write

jobs:
  create:
    runs-on: ubuntu-latest
    env:
      HEAD_BRANCH: ${{ github.event.pull_request.base.head }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
    steps:
      - name: Title Validation
        run: |
          TITLE="${{ env.PR_TITLE }}"
          if [[ "${TITLE}" != feat:* && "${TITLE}" != feature* ]]; then
            echo "PRs for features must start with feat: "
            exit 1
          fi

      - name: Extract Feature Message
        id: feature_message
        run: |
          TITLE="${{ env.PR_TITLE }}"
          MESSAGE=$(echo "${TITLE}" | sed -E 's/^(feat:|feature:)(.*)$/\2/')
          echo "MESSAGE=${MESSAGE}" >> $GITHUB_ENV

      - name: Update Features file in Base Branch
        uses: actions/github-script@v7
        with:
          script: |
            const message = '${{ env.MESSAGE }}';
            const baseBranch = process.env.BASE_BRANCH
            console.log(message);
            console.log(baseBranch);

            const { data: fileData } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'FEATURES.md',
              ref: baseBranch
            });

            let fileContents = Buffer.from(fileData.content, 'base64').toString('utf8');
            console.log(fileContents)

            // replace ## [Unreleased] section
            //fileContents = fileContents.replace(
            //);